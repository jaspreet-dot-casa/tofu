#cloud-config
# ARR-specific configuration

packages:
  - nfs-common

mounts:
  - [ "10.100.0.10:/export/media", "/mnt/media", "nfs", "defaults,timeo=14,intr", "0", "0" ]

write_files:
  - path: /tmp/install-docker.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      # Add Docker's official GPG key
      install -m 0755 -d /etc/apt/keyrings
      curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      chmod a+r /etc/apt/keyrings/docker.gpg

      # Set up repository
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

      # Install Docker
      apt-get update
      apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

      # Add user to docker group
      usermod -aG docker debian

      # Enable and start Docker
      systemctl enable docker
      systemctl start docker

      echo "Docker installation complete"

  - path: /home/debian/docker-compose.yml
    owner: debian:debian
    permissions: '0644'
    content: |
      version: "3.8"

      services:
        # Sonarr - TV Show management
        sonarr:
          image: lscr.io/linuxserver/sonarr:latest
          container_name: sonarr
          environment:
            - PUID=1000
            - PGID=1000
            - TZ=UTC
          volumes:
            - /home/debian/arr-config/sonarr:/config
            - /mnt/media/tv:/tv
            - /mnt/media/downloads:/downloads
          ports:
            - "8989:8989"
          restart: unless-stopped

        # Radarr - Movie management
        radarr:
          image: lscr.io/linuxserver/radarr:latest
          container_name: radarr
          environment:
            - PUID=1000
            - PGID=1000
            - TZ=UTC
          volumes:
            - /home/debian/arr-config/radarr:/config
            - /mnt/media/movies:/movies
            - /mnt/media/downloads:/downloads
          ports:
            - "7878:7878"
          restart: unless-stopped

        # Prowlarr - Indexer manager
        prowlarr:
          image: lscr.io/linuxserver/prowlarr:latest
          container_name: prowlarr
          environment:
            - PUID=1000
            - PGID=1000
            - TZ=UTC
          volumes:
            - /home/debian/arr-config/prowlarr:/config
          ports:
            - "9696:9696"
          restart: unless-stopped

        # qBittorrent - Download client
        qbittorrent:
          image: lscr.io/linuxserver/qbittorrent:latest
          container_name: qbittorrent
          environment:
            - PUID=1000
            - PGID=1000
            - TZ=UTC
            - WEBUI_PORT=8080
          volumes:
            - /home/debian/arr-config/qbittorrent:/config
            - /mnt/media/downloads:/downloads
          ports:
            - "8080:8080"
            - "6881:6881"
            - "6881:6881/udp"
          restart: unless-stopped

      networks:
        default:
          name: arr-stack

runcmd:
  - /tmp/install-docker.sh
  - mkdir -p /home/debian/arr-config/{sonarr,radarr,prowlarr,qbittorrent}
  - mkdir -p /mnt/media/{tv,movies,downloads}
  - chown -R debian:debian /home/debian/arr-config /mnt
  - sleep 30  # Wait for Docker to initialize
  - cd /home/debian && docker compose up -d
  - echo "ARR Stack deployment complete"